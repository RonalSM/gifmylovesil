<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Libro interactivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Estilos específicos para el libro (combinado con Tailwind) */
      :root{--bookW:90vw;--bookH:80vh}
      body{height:100vh}
      .book-cover{
        width: min(520px, var(--bookW));
        height: min(1036px, calc(var(--bookH) * 1)); /* otro 20% más alto */
        position:relative;
        perspective:1200px;
      }
      .book{
        width:100%;
        height:100%;
        position:relative;
        transform-style:preserve-3d;
        transition:transform .8s cubic-bezier(.2,.9,.3,1);
      }
      .cover-left,.cover-right{
        position:absolute;top:0;bottom:0;width:50%;background:linear-gradient(180deg,#7b3f2f,#4b1f12);box-shadow:0 8px 30px rgba(0,0,0,.4);border:4px solid #0b0b0b;display:flex;align-items:center;justify-content:center;color:#f7efe6;font-weight:700;backface-visibility:hidden;-webkit-backface-visibility:hidden;z-index:3;
      }
      .cover-left{left:0;border-right:2px solid rgba(0,0,0,.2);border-top-left-radius:6px;border-bottom-left-radius:6px}
      .cover-right{right:0;border-left:2px solid rgba(0,0,0,.2);border-top-right-radius:6px;border-bottom-right-radius:6px}
      .book.open .cover-right{transform-origin:left center;transform:rotateY(-160deg);transition:transform .9s cubic-bezier(.2,.9,.3,1);pointer-events:none}
      .book.open .cover-left{transform-origin:right center;transform:translateX(-6px) rotateY(10deg);opacity:.9;pointer-events:none}

      /* Al abrir, bajar la cubierta por debajo de la hoja y atenuar su visibilidad */
      .book.open .cover-left,
      .book.open .cover-right{
        z-index:-1000;
        opacity:0.00;
        transition:opacity .35s .2s, z-index 0s .4s;
      }

      .book.open .inner{opacity:1;transform:none;pointer-events:auto;z-index:4}

      /* Hoja interna */
      .inner{
        position:absolute;left:5%;right:5%;top:20%;bottom:20%;background:linear-gradient(180deg,#fff,#fbfaf8);box-shadow:inset 0 0 0 1px #e2dcd6,0 12px 30px rgba(0,0,0,.2);overflow:hidden;padding:18px;border-radius:6px;display:flex;flex-direction:column;opacity:1;transform:none;transition:opacity .28s,transform .28s;pointer-events:auto;z-index:4;
      }
      .page{flex:1;overflow:hidden;cursor:pointer;padding:8px}
      .page p{white-space:pre-wrap;margin:0;color:#111;line-height:1.45;font-size:clamp(14px, 3.5vw, 18px)}
      /* Estado inicial grande y centrado */
      .page.empty p{display:flex;align-items:center;justify-content:center;height:100%;font-size:clamp(28px, 10vw, 56px);font-weight:800;color:#3b1f12}
      .footer{display:flex;gap:8px;align-items:center;justify-content:space-between;padding-top:8px}

      /* Indicador pequeño */
      .indicator{font-size:12px;color:#6b6b6b}

      /* Medidor invisible para paginar */
      #measurer{position:absolute;visibility:hidden;left:-9999px;top:-9999px;width:calc(min(520px,var(--bookW)) - 64px)}

      @media (max-width:520px){
        .book-cover{--bookW:95vw;--bookH:85vh}
      }
    </style>
  </head>
  <body style="background-image:url('fondo.png');background-size:cover;background-position:center center;background-attachment:fixed;" class="flex items-center justify-center p-4">

    <div class="book-cover" id="bookCover">
      <div class="book mx-auto" id="book">
        <div class="inner" id="reader">
          <div class="page empty" id="pageArea">
            <p id="pageText">Abrir</p>
          </div>
          <div class="footer">
            <div class="indicator" id="posIndicator">—</div>
            <div class="text-xs text-gray-500">Toca la página para avanzar</div>
          </div>
        </div>
      </div>
    </div>

    <div id="measurer" aria-hidden="true"></div>

    <script>
      // Cargar JSON y paginar dinámicamente según el tamaño de la caja
      const book = document.getElementById('book');
      const pageArea = document.getElementById('pageArea');
      const pageText = document.getElementById('pageText');
      const posIndicator = document.getElementById('posIndicator');
      const measurer = document.getElementById('measurer');

      let contents = [];
      let currentContentIndex = 0; // índice en el JSON pages array
      let pagesForCurrent = [];   // array de strings paginados para la entrada actual
      let currentPageIndex = 0;
      let currentIndex = 0;
      let opened = false;

      // (Ahora la página 'Abrir' es la vista inicial)

      pageArea.addEventListener('click', async (e)=>{
        if (!opened){
          opened = true;
          pageText.textContent = 'Cargando…';
          try {
            const res = await fetch('content.json');
            contents = await res.json();
            if(Array.isArray(contents.pages) && contents.pages.length){
              pageArea.classList.remove('empty');
              currentIndex = 0;
              pageText.textContent = contents.pages[currentIndex];
              posIndicator.textContent = '';
            } else {
              pageText.textContent = 'El JSON no contiene "pages" o está vacío.';
            }
          } catch(err) {
            pageText.textContent = 'Error cargando content.json';
          }
          return;
        }
        // Si ya está abierto, avanzar al siguiente texto
        if(Array.isArray(contents.pages) && contents.pages.length){
          currentIndex = (currentIndex + 1) % contents.pages.length;
          pageText.textContent = contents.pages[currentIndex];
        }
      });

      // Permite retroceder con toque largo (sencillo): mantener pulsado
      let holdTimer = null;
      pageArea.addEventListener('pointerdown', ()=>{ holdTimer = setTimeout(()=>{ goBack(); }, 500); });
      pageArea.addEventListener('pointerup', ()=>{ clearTimeout(holdTimer); });
      pageArea.addEventListener('pointerleave', ()=>{ clearTimeout(holdTimer); });

      function goBack(){
        if(currentPageIndex>0){ currentPageIndex--; renderPage(); }
        else if(currentContentIndex>0){ currentContentIndex--; paginateCurrent(); currentPageIndex=pagesForCurrent.length-1; renderPage(); }
      }

      async function loadContent(){
        try{
          pageText.textContent = 'Cargando…';
          const res = await fetch('content.json');
          contents = await res.json();
          if(Array.isArray(contents.pages) && contents.pages.length){
            currentContentIndex = 0; paginateCurrent(); renderPage();
          } else {
            pageText.textContent = 'El JSON no contiene "pages" o está vacío.';
          }
        }catch(err){ pageText.textContent = 'Error cargando content.json'; console.error(err); }
      }

      // Paginación por párrafos: divide por \n\n, último párrafo muestra todo el texto
      function paginate(text){
        const paragraphs = text.split(/\n\n+/); // dividir por párrafos
        // crear páginas: cada párrafo es una página, excepto la última que es el texto completo
        let pages = paragraphs.map((p, idx) => {
          if(idx === paragraphs.length - 1) return text; // última página: texto completo
          return p;
        });
        return pages;
      }

      function paginateCurrent(){
        const text = (contents.pages && contents.pages[currentContentIndex]) || '';
        // si es corto, una página
        pagesForCurrent = paginate(text);
        currentPageIndex = 0;
        // quitar estado 'empty' cuando haya contenido para mostrar
        if(pagesForCurrent.length > 0){ pageArea.classList.remove('empty'); }
      }

      function renderPage(){
        const txt = pagesForCurrent[currentPageIndex] || '';
        pageText.textContent = txt || 'Sin contenido';
        posIndicator.textContent = `Página ${currentPageIndex+1} / ${pagesForCurrent.length}`;
      }

      // Recalcular paginación al rotar o cambiar tamaño
      let resizeTimer = null;
      window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer = setTimeout(()=>{ if(Array.isArray(contents.pages) && contents.pages.length) { paginateCurrent(); renderPage(); } }, 250); });

    </script>
  </body>
</html>
